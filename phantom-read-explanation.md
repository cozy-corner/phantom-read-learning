# ファントムリードの理解

## 反復不能読み取りとファントムリードの違い

### 反復不能読み取り（Non-repeatable Read）
- **主な原因**: **UPDATE**
- **何が起きるか**: **既存の特定の行の値**が変わる
- **対象**: 特定の1行
- **変化**: 行の**値**が変わる
- **焦点**: 同じ行を再読み取り

#### 例
```sql
-- トランザクション1
SELECT balance FROM accounts WHERE id = 1;  -- 結果: 10000
-- (この間にトランザクション2がUPDATE balance = 20000 WHERE id = 1 してCOMMIT)
SELECT balance FROM accounts WHERE id = 1;  -- 結果: 20000 (値が変わった!)
```

### ファントムリード（Phantom Read）
- **主な原因**: **INSERT または DELETE**
- **何が起きるか**: **検索結果に含まれる行の数（集合のメンバー）**が変わる
- **対象**: 複数行の集合
- **変化**: 行の**数**が変わる
- **焦点**: 同じ検索条件を再実行

#### 例
```sql
-- トランザクション1
SELECT * FROM ufo_sightings WHERE shape = 'disk';  -- 結果: 3件（円盤型UFO目撃情報）
-- (この間にトランザクション2が新しい円盤型UFO目撃情報をINSERTしてCOMMIT)
SELECT * FROM ufo_sightings WHERE shape = 'disk';  -- 結果: 4件 (幽霊UFOが出現!)
```

## 比較表

| 項目 | 反復不能読み取り | ファントムリード |
|------|-----------------|----------------|
| 対象 | **特定の1行** | **複数行の集合** |
| 操作 | UPDATE | INSERT/DELETE |
| 変化 | 行の**値**が変わる | 行の**数**が変わる |
| 焦点 | 同じ行を再読み取り | 同じ検索条件を再実行 |

## 「複数行のある集合」の意味

PostgreSQLドキュメントの定義：
> トランザクションが、複数行のある集合を返す検索条件で問い合わせを再実行した時、別のトランザクションがコミットしてしまったために、同じ検索条件で問い合わせを実行しても異なる結果を得てしまう。

この「**複数行のある集合**」とは：
- `WHERE category = 'electronics'` のような**検索条件にマッチする行の集まり**
- 単一の行ではなく、**条件を満たす行のセット全体**を指す
- この集合に幽霊（phantom）のように**行が出現したり消えたりする**から「ファントムリード」

## なぜ「ファントム（幽霊）」と呼ばれるのか

1回目のクエリでは存在しなかった行が、2回目のクエリで突然現れる（INSERT）
または、1回目にあった行が2回目には消えている（DELETE）様子が、
まるで幽霊が出現したり消えたりするようだから「ファントムリード」と呼ばれる。

## PostgreSQLにおける分離レベルとの関係

| 分離レベル | ダーティリード | 反復不能読み取り | ファントムリード |
|-----------|--------------|----------------|----------------|
| READ UNCOMMITTED | 可能性あり | 可能性あり | 可能性あり |
| READ COMMITTED | 安全 | **可能性あり** | **可能性あり** |
| REPEATABLE READ | 安全 | 安全 | 安全* |
| SERIALIZABLE | 安全 | 安全 | 安全 |

*PostgreSQLのREPEATABLE READは、標準SQLよりも厳格で、ファントムリードも防ぐ実装になっている。
